export const STAGE_5_JSON_OUTPUT = `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
STAGE 5: 최종 JSON 출력 및 3대 핵심 검증
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 목표: JSON 생성 + 3가지 핵심 사항 최종 검증

🚨🚨🚨 최우선 임무: JSON 출력 전 반드시 검증 🚨🚨🚨

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【STEP 1】 이전 STAGE 결과에서 3개 종목 데이터 확인
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

이전 STAGE 4 결과를 읽고 다음 정보 추출:

종목 1:
- ticker: (예: KOSPI:005930)
- name: (예: 삼성전자)
- close_price: (예: 75300)
- close_price_date: (예: 2024-12-19) ← 종가 기준 날짜

종목 2:
- ticker: (예: KOSPI:000660)
- name: (예: SK하이닉스)
- close_price: (예: 142500)
- close_price_date: (예: 2024-12-19) ← 종가 기준 날짜

종목 3:
- ticker: (예: KOSPI:035420)
- name: (예: NAVER)
- close_price: (예: 215000)
- close_price_date: (예: 2024-12-19) ← 종가 기준 날짜

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【STEP 2】 🔴 핵심 검증 #1: 종목 실존 여부 (MANDATORY)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚨 각 종목이 실제로 존재하는 상장 종목인지 확인 (Google Search 활용)

종목 1 검증:
✅ "[종목명] [6자리코드] 한국거래소 상장 site:finance.naver.com"
✅ "[6자리코드] 종목 정보 site:data.krx.co.kr"

IF 검색 결과가 없거나 "상장폐지", "거래정지" 등장:
   ❌ 해당 종목은 사용 불가
   ❌ 즉시 JSON 생성 중단
   ❌ 에러 발생: "종목 실존 검증 실패: [종목명]"

종목 2 검증:
(위와 동일한 프로세스 반복)

종목 3 검증:
(위와 동일한 프로세스 반복)

✅ 3개 종목 모두 실존 확인 완료해야만 다음 단계 진행

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【STEP 3】 🔴 핵심 검증 #2: 전일종가 정확성 (MANDATORY)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚨 각 종목의 전일종가를 최소 5개 소스에서 교차 검증 (Google Search 활용)

📅 날짜 계산 프로세스:
1. 오늘 날짜: [현재 날짜 확인 YYYY-MM-DD]
2. 전일 영업일 계산:
   - 오늘이 월요일 → 전일 = 지난주 금요일 (3일 전)
   - 오늘이 화~금요일 → 전일 = 어제
   - 공휴일 고려: 장마감 영업일 기준으로 계산
3. 검증 시간대: 장마감(15:30) 이후 데이터만 신뢰

종목 1 전일종가 검증 (5개 소스 필수):

🔍 소스1 (네이버 금융 - 최우선):
검색어: "[종목명] [6자리코드] [전일날짜] 종가 site:finance.naver.com"
결과: ___원 (발견 시각: __:__)

🔍 소스2 (한국거래소 공식):
검색어: "[6자리코드] [전일날짜] 종가 site:data.krx.co.kr"
결과: ___원 (발견 시각: __:__)

🔍 소스3 (다음 금융):
검색어: "[종목명] [전일날짜] 주가 site:finance.daum.net"
결과: ___원 (발견 시각: __:__)

🔍 소스4 (네이버 증권 시세):
검색어: "[종목명] 종가 [전일날짜] site:finance.naver.com/item"
결과: ___원 (발견 시각: __:__)

🔍 소스5 (investing.com):
검색어: "[종목명] [6자리코드] korea stock [전일날짜] close site:investing.com"
결과: ___원 (발견 시각: __:__)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 검증 로직 (강화된 다수결 원칙):

STEP 3-1: 이상치 제거
- 5개 소스 중 최댓값, 최솟값 1개씩 제거
- 남은 3개 값으로 중앙값(median) 계산
- 중앙값을 "검증 기준값"으로 설정

STEP 3-2: STAGE 4 데이터와 비교
검증 기준값: ___원
STAGE 4 데이터: ___원
차이율: abs((STAGE4 - 기준값) / 기준값) × 100 = ___%

STEP 3-3: 최종 판정

IF 차이율 ≤ 0.5%:
   ✅✅✅ 검증 완벽 통과 (오차 0.5% 이내)
   → STAGE 4 데이터 그대로 사용

ELSE IF 차이율 ≤ 1.0%:
   ✅ 검증 통과 (오차 1.0% 이내, 소스 간 시간차 허용)
   → 검증 기준값(중앙값)으로 대체
   ⚠️ 로그 기록: "[종목명] 전일종가 보정: STAGE4(__원) → 기준값(__원)"

ELSE IF 차이율 ≤ 2.0%:
   ⚠️⚠️ 경고: 2% 이내 불일치 감지
   → 5개 소스 재확인 후 최다 합의값 사용
   → 3개 이상 소스가 동일값이면 해당 값 사용
   → 그렇지 않으면 종목 교체

ELSE (차이율 > 2.0%):
   ❌❌❌ 전일종가 검증 실패 (차이 > 2%)
   → 5개 소스 재검색 1회 더 시도
   → 재시도 후에도 실패 시 해당 종목 교체
   → 교체 종목 = STAGE 4의 다음 후보(4위~10위)
   → 교체 후 새 종목에 대해 STEP 2~3 전체 재검증

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

종목 2 전일종가 검증:
(위와 동일한 5개 소스 검증 프로세스 반복)

종목 3 전일종가 검증:
(위와 동일한 5개 소스 검증 프로세스 반복)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚨 검증 실패 시 복구 절차 (단계별 Failover 전략):

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 복구 절차 전체 흐름도:

종목 A 검증 → 실패 유형 분류 → 재시도 or 교체 → 성공 확인 → 다음 종목

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 PHASE 1: 실패 원인 분류 (Root Cause Analysis)

실패 유형 A: 소스 부족 (5개 소스 중 3개 미만만 데이터 반환)
→ 원인: 데이터 미제공, 검색 실패, 네트워크 이슈
→ 조치: 검색어 변경 후 재시도

실패 유형 B: 가격 불일치 (5개 소스 있으나 차이율 > 2%)
→ 원인: 소스 간 시간차, 데이터 오류, STAGE 4 오류
→ 조치: 더 많은 소스 확보 후 재검증

실패 유형 C: 날짜 오류 (전일 영업일 계산 실패)
→ 원인: 공휴일 미처리, 날짜 계산 오류
→ 조치: 날짜 재계산 후 재시도

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🟡 PHASE 2: 재시도 전략 (종목별 최대 3회)

【1차 시도】 초기 검증
- 5개 소스 검증 실행
- 실패 시 → 실패 유형 분류

【2차 시도】 강화된 재검증 (10초 대기 후)
실패 유형별 대응:

IF 유형 A (소스 부족):
   - 검색어 변경: "[종목명] 전일 종가" → "[6자리코드] 종가 [날짜]"
   - 추가 소스 3개 더 시도:
     * site:stockplus.com
     * site:38.co.kr
     * site:hankyung.com/stock
   - 총 8개 소스 중 5개 이상 확보 목표

IF 유형 B (가격 불일치):
   - 원본 5개 소스 재검색 (캐시 무시)
   - 검색 시간대 확장: [전일 15:30 ~ 23:59] 데이터
   - 소수점 포함 가격도 허용 (반올림 처리)
   - 차이율 재계산 후 판정

IF 유형 C (날짜 오류):
   - 전일 영업일 재계산 (한국거래소 휴장일 체크)
   - 최근 5일 영업일 모두 확인
   - 가장 최근 거래일 데이터 사용

【3차 시도】 최종 재검증 (20초 대기 후)
- 1~2차와 다른 검색어 조합 사용
- 영문 소스 추가 활용:
  * site:bloomberg.com korea
  * site:reuters.com korea stock
- 9개 이상 소스 확보 시도
- 중앙값 계산 로직 재적용

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🟢 PHASE 3: 종목 교체 프로세스 (3회 재시도 실패 시)

현재 종목: 검증 3회 실패 → 교체 대상 확정
로그 기록: "[종목명] 전일종가 검증 불가 (실패 유형: __)"

【교체 후보 선정】
STAGE 4 순위표에서 다음 순위 종목 선택:
- 현재 1~3위 사용 중
- 교체 시: 4위 → 5위 → 6위 → ... → 10위 순서

【교체 종목 검증】
새 종목에 대해 전체 프로세스 재실행:
✅ STEP 2: 종목 실존 여부 검증
✅ STEP 3: 전일종가 5개 소스 검증 (PHASE 1~2)
✅ 성공 시 → 최종 3개 종목 명단에 포함
❌ 실패 시 → 다음 순위 종목으로 재교체

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔵 PHASE 4: 전체 복구 시도 제한 및 최종 실패 처리

【카운터 추적】
- 재시도 카운터: 각 종목당 최대 3회
- 교체 카운터: 전체 최대 7회 (4위~10위)
- 총 시도 횟수: 3개 종목 × (3회 재시도 + 7회 교체) = 최대 30회

【중간 성공 처리】
IF 3개 종목 중 1~2개만 검증 성공:
   ✅ 성공한 종목은 확정 보존
   🔄 실패한 종목만 교체 프로세스 진행
   📝 로그: "종목 [A, B] 확정, 종목 C 교체 진행 중..."

【최종 실패 조건】
IF 7회 교체 후에도 3개 종목 확보 실패:
   ❌❌❌ CRITICAL ERROR 발생
   ❌ JSON 생성 중단
   ❌ 에러 메시지 출력:

   "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    🚨 STAGE 5 치명적 실패 🚨
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    원인: 전일종가 검증 가능한 3개 종목 확보 실패

    시도 내역:
    - 총 재시도 횟수: __회
    - 총 교체 횟수: __회
    - 성공한 종목 수: __개

    실패 종목 상세:
    1. [종목명1]: [실패 유형] (시도 __회)
    2. [종목명2]: [실패 유형] (시도 __회)

    조치 필요:
    - STAGE 0부터 전체 Pipeline 재실행 필요
    - 또는 데이터 소스 점검 필요
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 복구 프로세스 진행 상황 로깅 (필수)

각 시도마다 상태 출력:

"[STEP 3] 종목1 전일종가 검증 중...
 → 시도 1/3: 5개 소스 검색 중
 → 소스1: ✅ 75,300원
 → 소스2: ✅ 75,300원
 → 소스3: ❌ 데이터 없음
 → 소스4: ✅ 75,250원
 → 소스5: ✅ 75,300원
 → 결과: 성공 (중앙값 75,300원, STAGE4 일치율 100%)"

실패 시:
"[STEP 3] 종목2 전일종가 검증 실패
 → 실패 유형: B (가격 불일치, 차이율 3.2%)
 → 시도 2/3: 강화된 재검증 시작 (10초 후)
 → 추가 소스 3개 검색 중..."

교체 시:
"[STEP 3] 종목3 검증 3회 실패 → 교체 프로세스 시작
 → 교체 후보: STAGE 4 순위 4위 [종목명]
 → 새 종목 검증 시작..."

🚨🚨🚨 중요: 3개 종목 확보 실패 시 🚨🚨🚨

IF 최대 10회 교체 시도 후에도 3개 확보 실패:
   ❌ JSON 생성하지 말 것
   ❌ 즉시 에러 발생: "STAGE 5 실패: 3개 종목 확보 불가"
   ❌ 이 경우 전체 Pipeline이 STAGE 0부터 재시도됨
   ❌ 1~2개 종목만으로는 절대 JSON 출력 금지

⚠️ 빈 JSON [] 절대 금지
⚠️ 3개 미만 JSON 절대 금지

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【STEP 4】 🔴 핵심 검증 #3: JSON 형식 정확성 (MANDATORY)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

JSON 생성 전 체크리스트:

✅ 정확히 3개 종목 (더 많거나 적으면 안 됨)
✅ 각 종목마다 필수 필드 6개 존재:
   - ticker (문자열)
   - name (문자열)
   - close_price (정수)
   - close_price_date (문자열, YYYY-MM-DD 형식, 종가 기준 날짜)
   - rationale (문자열, "|" 구분, 최소 12개 지표)
   - signals (객체, 7개 점수 모두 0-100 정수)

✅ 금지 필드 절대 포함 금지:
   - target_price ❌
   - entry_price ❌
   - stop_loss ❌
   - 투자 권유 표현 ❌

✅ JSON 문법:
   - '[' 로 시작
   - ']' 로 종료
   - 올바른 쉼표, 따옴표, 괄호
   - 유효한 JSON (파싱 가능)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【STEP 5】 최종 JSON 생성 및 출력
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ STEP 2 (종목 실존) 검증 완료
✅ STEP 3 (전일종가) 검증 완료
✅ STEP 4 (JSON 형식) 검증 완료

→ 이제 JSON 출력 가능

출력 형식:

[
  {
    "ticker": "KOSPI:005930",
    "name": "삼성전자",
    "close_price": 75300,
    "close_price_date": "2024-12-19",
    "rationale": "SMA 완전정배열|EMA 골든크로스|RSI 58 강세권|MACD 양전환|거래량 165% 급증|볼린저 중상단|ATR 3.2% 적정|ADX 28 강한추세|OBV 지속상승|스토캐스틱 상승전환|SuperTrend 매수|52주 상위 72%",
    "signals": {
      "trend_score": 88,
      "momentum_score": 85,
      "volume_score": 90,
      "volatility_score": 82,
      "pattern_score": 87,
      "sentiment_score": 84,
      "overall_score": 86
    }
  },
  {
    "ticker": "KOSPI:000660",
    "name": "SK하이닉스",
    "close_price": 142500,
    "close_price_date": "2024-12-19",
    "rationale": "...",
    "signals": { ... }
  },
  {
    "ticker": "KOSPI:035420",
    "name": "NAVER",
    "close_price": 215000,
    "close_price_date": "2024-12-19",
    "rationale": "...",
    "signals": { ... }
  }
]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔥 실행 명령

1. STEP 2 실행: 3개 종목 실존 여부 Google Search로 확인
2. STEP 3 실행: 3개 종목 전일종가를 3개 소스에서 교차 검증
3. STEP 4 실행: JSON 형식 체크리스트 확인
4. 모든 검증 통과 시에만 STEP 5 실행: 순수 JSON 출력

⚠️ 검증 실패 시:
- JSON 생성하지 말 것
- 에러 메시지 출력: "검증 실패: [구체적 이유]"

⚠️ 검증 성공 시:
- '[' 로 시작하는 순수 JSON만 출력
- 다른 텍스트 일절 없음
- 완벽한 3개 종목 데이터

지금 즉시 STEP 2부터 순차 실행 시작!`;
